<script setup lang="ts">
import { ref, computed } from 'vue'
import { GroupManager } from '../classes/GroupManager'
import { useToast } from '../composables/useToast'
import type { Contact } from '../classes/Contact'
import ConfirmModal from './ConfirmModal.vue'

const { showToast } = useToast()

const groups = computed(() => GroupManager.groups)
const openGroups = ref<Set<string>>(new Set())

function toggleGroup(name: string) {
  if (openGroups.value.has(name)) {
    openGroups.value.delete(name)
  } else {
    openGroups.value.add(name)
  }
}

function isGroupOpen(name: string) {
  return openGroups.value.has(name)
}

const editingContactId = ref<string | null>(null)
const editingGroupName = ref<string | null>(null)

const editedName = ref('')
const editedPhone = ref('')

function startEditContact(groupName: string, contact: Contact) {
  editingContactId.value = contact.id
  editingGroupName.value = groupName
  editedName.value = contact.name
  editedPhone.value = contact.phone
}

function cancelEdit() {
  editingContactId.value = null
  editingGroupName.value = null
}

function saveEdit() {
  if (!editingGroupName.value || !editingContactId.value) return

  const success = GroupManager.updateContact(editingGroupName.value, editingContactId.value, editedName.value, editedPhone.value)
  if (success) {
    showToast('–ö–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 'success')
  } else {
    showToast('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è', 'error')
  }

  cancelEdit()
}

// üóë Modal delete logic
const isModalOpen = ref(false)
const contactToDelete = ref<{ groupName: string, contactId: string } | null>(null)

function requestDelete(groupName: string, contactId: string) {
  isModalOpen.value = true
  contactToDelete.value = { groupName, contactId }
}

function confirmDelete() {
  const { groupName, contactId } = contactToDelete.value!
  const success = GroupManager.removeContactByGroup(groupName, contactId)
  if (success) {
    showToast('–ö–æ–Ω—Ç–∞–∫—Ç —É–¥–∞–ª—ë–Ω', 'success')
  } else {
    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error')
  }

  isModalOpen.value = false
  contactToDelete.value = null
}
</script>

<template>
  <div class="contact-list">
    <ul class="group-list">
      <li v-for="group in groups" :key="group.name" class="group">
        <div class="group__header" @click="toggleGroup(group.name)">
          <h3>{{ group.name }}</h3>
          <span class="arrow" :class="{ open: isGroupOpen(group.name) }">&#9662;</span>
        </div>
        <transition name="slide-down">
          <ul v-if="isGroupOpen(group.name)" class="contact-list__items">
            <li v-for="contact in group.contacts" :key="contact.id" class="contact-item">
              <div class="contact-item__info">
                <template v-if="editingContactId === contact.id">
                  <input v-model="editedName" />
                </template>
                <template v-else>
                  <span class="contact-name">{{ contact.name }}</span>
                </template>
              </div>
              <div class="contact-item__right">
                <template v-if="editingContactId === contact.id">
                  <input v-model="editedPhone" />
                  <button @click="saveEdit" class="icon-btn">‚úÖ</button>
                  <button @click="cancelEdit" class="icon-btn danger">‚úñÔ∏è</button>
                </template>
                <template v-else>
                  <span class="contact-phone">{{ contact.phone }}</span>
                  <button
                    @click="startEditContact(group.name, contact)"
                    class="icon-btn"
                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                    :disabled="!!editingContactId"
                  >
                    ‚úé
                  </button>
                  <button
                    @click="requestDelete(group.name, contact.id)"
                    class="icon-btn danger"
                    title="–£–¥–∞–ª–∏—Ç—å"
                    :disabled="!!editingContactId"
                  >
                    üóë
                  </button>
                </template>
              </div>
            </li>
          </ul>
        </transition>
      </li>
    </ul>

    <ConfirmModal
      v-if="isModalOpen"
      @confirm="confirmDelete"
      @cancel="isModalOpen = false"
    />
  </div>
</template>

<style scoped lang="scss">
.contact-list {
  max-width: 1160px;
  margin: 0 auto;
  padding: 1rem;
}

.group-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.group {
  background-color: #ffffff;
  border-radius: var(--border-radius);
  margin-bottom: 1.5rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
  overflow: hidden;

  &__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    cursor: pointer;
    font-weight: 600;
    border-bottom: 1px solid #e5e7eb;

    h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .arrow {
      transition: transform 0.3s ease;
      font-size: 1rem;
      color: #444;
      &.open {
        transform: rotate(180deg);
      }
    }
  }
}

.contact-list__items {
  list-style: none;
  padding: 0;
  margin: 0;

  .contact-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #f0f0f0;

    &:last-child {
      border-bottom: none;
    }

    &__info {
      flex: 1;
      .contact-name {
        font-weight: 500;
      }

      input {
        padding: 0.3rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
    }

    &__right {
      display: flex;
      align-items: center;
      gap: 0.5rem;

      input {
        padding: 0.3rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .contact-phone {
        margin-right: 0.5rem;
        font-size: 0.95rem;
        color: #333;
      }

      .icon-btn {
        background: none;
        border: none;
        padding: 0.2rem;
        cursor: pointer;
        color: #555;
        transition: color 0.2s ease;

        &:hover {
          color: #000;
        }

        &.danger:hover {
          color: #e11d48;
        }
      }
    }
  }
}

// –ê–Ω–∏–º–∞—Ü–∏—è –≤—ã–µ–∑–¥–∞
.slide-down-enter-active {
  max-height: 1000px;
  opacity: 1;
  transition: max-height 0.4s ease, opacity 0.3s ease;
}
.slide-down-leave-active {
  max-height: 0;
  opacity: 0;
  transition: max-height 0.3s ease, opacity 0.2s ease;
}
.slide-down-enter-from,
.slide-down-leave-to {
  max-height: 0;
  opacity: 0;
}
</style>
